---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing 
your cursor inside it and pressing *Ctrl+Shift+Enter*. 

## library packages
```{r}
library(data.table)
library(tidyverse)
```

## import data
```{r}
ecoupon <- read.csv("C:\\Users\\user\\Desktop\\data_science\\91APP\\ECoupon.csv",
  header=T,sep=",",fileEncoding ="UTF-8-BOM")
orders <- read.csv("C:\\Users\\user\\Desktop\\data_science\\91APP\\Orders.csv",
  header=T,sep=",",fileEncoding ="UTF-8-BOM") %>%
  mutate(OrderGroupCode=str_trim(OrderGroupCode, side = "both"))
members <- read.csv("C:\\Users\\user\\Desktop\\data_science\\91APP\\Member.csv",
  header=T,sep=",",fileEncoding ="UTF-8-BOM")
promotion <- read.csv("C:\\Users\\user\\Desktop\\data_science\\91APP\\PromotionOrders.csv",
  header=T,sep=",",fileEncoding ="UTF-8-BOM")
```

```{r}
#sorders <- head(orders, 10000)
#smembers <- sample_n(members, 10000)
#spromotion <- sample_n(promotion, 10000)
```

## 新增欄位小時與年月日
```{r}
orders <- orders %>%
  mutate(weekday = as.POSIXct(SalesOrderSlaveDateTime)) %>%
  mutate(weekday = weekdays(weekday)) %>%
  mutate(hr = strftime(SalesOrderSlaveDateTime,format="%H" )) %>%
  mutate(yearmonth= strftime(SalesOrderSlaveDateTime,format="%Y-%m-%d"))
```

## dta 1
```{r}
dta1 <- orders[,c(4,5,6,9,12,13,17,18,29,30)] 

## plot G1 (relation between totalpayment ,hr , device)
g1 <- dta1 %>%
  group_by(hr,TrackSourceTypeDef) %>%
  subset(IsMajor != TRUE) %>%
  summarise(meanpay = mean(SalesOrderSlaveTotalPayment, na.rm = TRUE),
            sumquantity = sum(Quantity, na.rm = TRUE),
            sumpay = sum(SalesOrderSlaveTotalPayment, na.rm = TRUE))
ggplot(g1,aes(x=hr, y=sumpay,group = TrackSourceTypeDef))+ 
    geom_line(aes(color=TrackSourceTypeDef))+
    geom_point(aes(color=TrackSourceTypeDef))+
    scale_color_manual(values=c("steelblue3", "violetred3","mediumpurple3"))+
    labs(x = "hour", y = "mean payment (NT)", size=16)+
    theme(axis.text.x=element_text(angle=60),legend.position="top")
```

```{r}
## plot G2 (relation between totalpayment ,hr , device)
g2 <- dta1 %>%
  group_by(weekday,TrackSourceTypeDef) %>%
  subset(IsMajor != TRUE) %>%
  summarise(meanpay = mean(SalesOrderSlaveTotalPayment, na.rm = TRUE),
            sumquantity = sum(Quantity, na.rm = TRUE),
            sumpay = sum(SalesOrderSlaveTotalPayment, na.rm = TRUE))
ggplot(g2,aes(x=weekday, y=sumpay,group=TrackSourceTypeDef))+ 
    geom_line(aes(color=TrackSourceTypeDef))+
    geom_point(aes(color=TrackSourceTypeDef))+
    scale_x_discrete(limits=c("星期一","星期二","星期三","星期四","星期五","星期六","星期日"))+
    scale_color_manual(values=c("steelblue3", "violetred3","mediumpurple3"))+
    labs(x = "hour", y = "mean payment (NT)", size=16)+
    theme(axis.text.x=element_text(angle=60),legend.position="top")
```


## dta 2
```{r}
dta2 <- orders[,-c(8,19,21,22,23,24,25,26,27,28)] 
```

```{r}
## 篩選購物次數>1的客戶
b <- dta2[,c(2,3)] %>%
  group_by(OrderGroupCode,MemberId) %>%
  summarise(n =n()) 

filter_g3 <- count(b[,c(2)],MemberId ) %>%
  subset(n!=1)

##套回原本的data
g3 <- dta2 %>%
  group_by(MemberId,OrderGroupCode,yearmonth) %>%
  summarise(totalpay = sum(SalesOrderSlaveTotalPayment),
            totalquan = sum(Quantity)) %>%
  filter(MemberId %in% filter_g3$MemberId) %>%
  mutate(yearmonth = as.POSIXct(yearmonth))

## 計算同一客戶不同次購買的天數差距
g3 <- g3 %>%
  group_by(MemberId) %>% 
  arrange(yearmonth) %>%
  mutate(diff = difftime(lead(yearmonth),yearmonth,units = "days"))

## 計算平均間隔平均間隔天數
a <- subset(g3, diff !=0| NA ) %>% mutate(diff= as.numeric(diff))
meanday <- colMeans(a[,6])

a <- a %>%
  mutate(membertype = case_when (diff < meanday ~ "F1",
         meanday<=diff & diff < (meanday*2) ~"F2",
         diff >= (meanday*2) ~"F3"))

head(a)
##
```

## draw member type (donut chart) F0為止消費過一次/ F1為消費週期<1/ F2為<1消費週期<2/ F3為消費週期>2
```{r}

ggplot(a, aes(x=2,fill=membertype))+
  #blank_theme +
  geom_bar(stat = "count",position="fill")+
  coord_polar(theta = "y")
```

##消費週期和購買量與金額、折扣金額的關係
```{r}
dta3 <- left_join(dta2, a[,c(1,7)] ,by= c("MemberId")) %>%
  mutate(membertype = replace_na(.$membertype, "F0")) %>%
  group_by(MemberId,membertype,City) %>%
  summarise(totalpay = sum(SalesOrderSlaveTotalPayment),
            totalquan = sum(Quantity),
            totaldiscount = sum(PromotionDiscount + ECouponDiscount))

d <- dta3 %>%
  group_by(membertype) %>%
  summarise(pay = round(mean(totalpay)),
            quan = round(mean(totalquan)),
            discount = abs(round(mean(totaldiscount)))) %>%
  mutate(membertype = case_when(membertype == "F0" ~ 0,
                                membertype == "F1" ~ 1,
                                membertype == "F2" ~ 2,
                                membertype == "F3" ~ 3))

ggplot(d,aes(x=membertype))+ 
    geom_line(aes(y = quan, colour="Quantity"),size = 1.5)+
    geom_line(aes(y = pay/200, colour="Payment"),size = 1.5)+
    geom_bar(aes(y = discount/200, fill= "discount" ), 
             stat = "identity",width = 0.3)+
    scale_y_continuous(sec.axis = sec_axis(~.*200, name = "mean payment (NT)"))+
    geom_point(aes(y= pay/200, colour="Payment"), size =3)+
    geom_point(aes(y= quan, colour="Quantity"), size = 3)+
    scale_color_manual(values=c("steelblue3", "mediumpurple3"))+
    scale_fill_manual(values=c("palegreen3"))+
    labs(x = "member type", y = "mean quantity", size=16)+
    #scale_x_discrete(labels=c("0"="消費1次", "1"="消費週期小於1",
                             # "2"="消費週期大於1小於2", "3"="消費週期大於2"))+
    theme(axis.text.x=element_text(angle=60), legend.position="top")

```

## 以消費總金額分類客戶(T0= <-1SD, T1=-1SD~1SD, T2= >1SD )
```{r}
m <- mean(dta3$totalpay)
s <- sd(dta3$totalpay)

dta4 <- dta3 %>%
  mutate(membertype2 = case_when(totalpay <= m-s ~ "T0",
                                 totalpay > m-s & totalpay <= m+s ~ "T1",
                                 totalpay > m+s ~ "T2"))
  #subset(membertype != "F0")

# F0 <- filter(dta4, membertype == "F0")
# F1 <- filter(dta4, membertype == "F1") %>%
#   left_join(., filter_g3, by = "MemberId")
# F2 <- filter(dta4, membertype == "F2") %>%
#   left_join(., filter_g3, by = "MemberId")
# F3 <- filter(dta4, membertype == "F3") %>%
#   left_join(., filter_g3, by = "MemberId")




ggplot(dta4, aes(x= membertype, fill= membertype2))+
   geom_bar(alpha=0.7, position="fill",width = .5)+
   labs(x = "member type", y = "people", size=16)
  

dta3 <- subset(dta3, totalpay < 500000)

```

```{r}
ggplot(dta3, aes(x= MemberId, y= totalpay))+
  geom_point() +
  expand_limits( y=c(0, 50000))
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.


When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
